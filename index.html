<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="index.css">
	<link rel="stylesheet" href="colors.css">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz" crossorigin="anonymous">
	<title>Найди пару</title>
</head>
<body>
	<h1 class="center">Игра: найди пару цветов</h1>
	<hr>
	<i class="fas fa-home fa-2x" id="homeButton"></i>
	<div class="start-page-form center" id="startForm">
			Размер поля:<br>
			<div>
				<input type="radio" name="fieldSize">2x2<br>
				<input type="radio" name="fieldSize" checked>4x4<br>
				<input type="radio" name="fieldSize">6x6<br>
				<input type="radio" name="fieldSize">8x8<br>
			</div>
			<input type="submit" name="enter" value="Начать" onclick="formHandler()">
	</div>

	<h3 id="clickAmount" class="center">Количество открытий: 0</h3>
	<h3 id="winReport" class="center">Игра закончена</h3>

	<div class="game-field" id="gameField"></div>

	<div class="center" id="restartGameButton">
	  <button>Начать сначала</button>
  	</div>
	<script>
		function backStartPage() {
			clickAmount.style.visibility = "hidden";
			gameField.style.visibility = "hidden";
			restartGameButton.style.visibility = "hidden";
			homeButton.style.visibility = "hidden";

			startForm.style.display = "";

			codes = [];

			for (var i = 0; i < outerBlock.length; i++) {
				outerBlock[i].remove();
			}
		}


		// Вызов следующей функции убирает стартовую страницу(где выбор размера) и
		// показывет игровое поле. Также здесь собираются в списки внешние
		// и внутренние div и присваивается ширина для поля.
		function showGameField() {
			outerBlock = document.querySelectorAll(".game-field > div");
			innerBlock = document.querySelectorAll(".game-field div div");//Собираем блоки в коллекцию
			gameField.style.width = fieldSize*100 + "px";

			startForm.style.display = "none";

			clickAmount.style.visibility = "";
			gameField.style.visibility = "";
			restartGameButton.style.visibility = "";
			homeButton.style.visibility = "";
		}

		// Эта функция обрабатывает форму на стартовой странице(выбор размера и тд).
		// Функия берет значения, выбранные пользователем и в соответствие с ними
		// создает игровое поле и начинает игру.
		// Здесь вызываются функции showGameField и startGame
		function formHandler() {
			let inputs = document.querySelectorAll("#startForm div input");
			for (let i = 0; i < inputs.length; i++) {
				if (inputs[i].checked) {
					fieldSize = (i + 1) * 2;
				};
			};


			for (var i = 0; i < fieldSize*fieldSize; i++) {
				gameField.insertAdjacentHTML("afterBegin", "<div><div></div></div>");
			};

			for (let i = 1; i <= fieldSize * fieldSize / 2; i++) {
				codes.push(i);
				codes.push(i);
			};

			showGameField();
			startGame();
		};


		// Функция начинающая или сбрасывающая игру. Она присваивает различные цвета клеткам
		// и сразу же скрывает их. Также она сбрасывает значение clickCounter amountOfFoundPairs и
		// скрывает сообщение о победе winReport.
		function startGame() {
	  		winReport.style.visibility = "hidden";
	   	amountOfFoundPairs = 0;
	   	clickCounter = 0;
	   	clickAmount.innerHTML = 'Количество открытий: ' + clickCounter;

			mixCodes();

			//Присваиваиваем блокам цвета и скрываем их
			for(let i = 0; i < innerBlock.length; i++) {
				innerBlock[i].className = "";
	  			innerBlock[i].className = "color-" + codes[i];
	  	   	innerBlock[i].style.visibility = 'hidden';
	  			outerBlock[i].onclick = clickHandler;
			};
		};

		//Мешает массив codes
		function mixCodes() {
			codes.sort(compareRandom);

			function compareRandom(a, b) {
				return Math.random() - 0.5;
			};
		};

		//Прячет последние два цвета
		function hideTwoLastColors() {
			isTimeOut = false;
			currentColor.style.visibility = 'hidden';
			lastColor.style.visibility = 'hidden';
		};

		// Функция-обработчик клика по клетке.
		function clickHandler() {
			//Проверка успела ли сработать функция hideTwoLastColors
			// Нужна для того, чтобы если пользователь кликнул на клетку, до того как
			// скрылись две открытые им клетки до этого, они сразу же скрывались и
			// не происходили какие-либо нестыковки.
			if (isTimeOut) {
		   	clearTimeout(timerId);
		   	hideTwoLastColors();
			};

			clickCounter += 1;
			clickAmount.innerHTML = 'Количество открытий: ' + clickCounter;

			//Показывается цвет клетки, на которую нажал пользователь, а также
			//записывается в переменную
			currentColor = this.querySelector('div');
			currentColor.style.visibility = '';

			//Если открываем первый цвет, то он также записывается в переменную
			//с последним цветом, а клетка с ним перестает вызывать функцию-обработчик клика
			if (clickCounter % 2 == 1) {
		   	lastColor = currentColor;
		   	this.onclick = "";

			//Если открываем второй цвет то проверяем совпал ли он с первым
			} else {

		   	//Если не совпал с первым цветом, то с задержкой вызываем
				// функцию hideTwoLastColors, которая скроет эти две клетки.
				// Также делаем первую клеткю снова активной для клика
		   	if (lastColor.className != currentColor.className) {
		   	  	isTimeOut = true;
		   	  	timerId = setTimeout(hideTwoLastColors, 600);
		   	  	lastColor.parentElement.onclick = clickHandler;

				//Если совпал с первым цветом, то делаем клекти неактивными и
				// увеличиваем кол-во найденных пар на 1
		   	} else {
		     		lastColor.parentElement.onclick = "";
		     		this.onclick = "";
		   	  	amountOfFoundPairs += 1

		  	   	//Если открыли все пары цветов
		 	    	if (amountOfFoundPairs == 8) {
			     		winReport.style.visibility = "visible";
		     		};
		    	};
		  	};
		};

		let lastColor = "";
		let currentColor = "";
		let clickCounter = 0;
		let isTimeOut = false;
		let timerId = 0;
		let amountOfFoundPairs = 0;
		let codes = []; //Коды для дальнейшего присвания блокам
		let outerBlock;
		let innerBlock;
		let fieldSize;//Длина стороны поля

		restartGameButton.onclick = startGame;
		homeButton.onclick = backStartPage;

		//Прячем поле, счетчик кликов и кнопку рестарта игры
		clickAmount.style.visibility = "hidden";
		gameField.style.visibility = "hidden";
		restartGameButton.style.visibility = "hidden";
		homeButton.style.visibility = "hidden";
	</script>
</body>
</html>
