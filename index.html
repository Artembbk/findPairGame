<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="index.css">
	<link rel="stylesheet" href="colors.css">
	<title>Найди пару</title>
</head>
<body>
	<h1 class="center">Игра: найди пару цветов</h1>
	<hr>

	<div class="start-page-form center" id="startForm">
			Размер поля:<br>
			<div>
				<input type="radio" name="fieldSize">2x2<br>
				<input type="radio" name="fieldSize" checked>4x4<br>
				<input type="radio" name="fieldSize">6x6<br>
				<input type="radio" name="fieldSize">8x8<br>
			</div>
			<input type="submit" name="enter" value="Начать" onclick="formHandler()">
	</div>

	<h3 id="clickAmount" class="center">Количество открытий: 0</h3>
	<h3 id="winReport" class="center">Игра закончена</h3>

	<div class="game-field" id="gameField"></div>

	<div class="center" id="restartGameButton">
	  <button>Начать сначала</button>
  	</div>
	<script>
		function showGameField() {
			outerBlock = document.querySelectorAll(".game-field > div");
			innerBlock = document.querySelectorAll(".game-field div div");//Собираем блоки в коллекцию
			gameField.style.width = fieldSize*100 + "px";

			startForm.style.display = "none";

			clickAmount.style.visibility = "";
			gameField.style.visibility = "";
			restartGameButton.style.visibility = "";
		}

		function formHandler() {
			let inputs = document.querySelectorAll("#startForm div input")
			for (let i = 0; i < inputs.length; i++) {
				if (inputs[i].checked) {
					fieldSize = (i + 1) * 2;
				}
			}


			for (var i = 0; i < fieldSize*fieldSize; i++) {
				gameField.insertAdjacentHTML("afterBegin", "<div><div></div></div>");
			};

			showGameField();
			startGame();
		};



		function startGame() {
	   	winReport.style.visibility = "hidden";
	   	amountOfFoundPairs = 0;
	   	clickCounter = 0;
	   	clickAmount.innerHTML = 'Количество открытий: ' + clickCounter;

			for (let i = 1; i <= fieldSize * fieldSize / 2; i++) {
				codes.push(i);
				codes.push(i);
			}
			mixCodes();

			//Присваиваиваем блокам цвета и скрываем их
			for(let i = 0; i < innerBlock.length; i++) {
				innerBlock[i].className = "";
	  			innerBlock[i].className = "color-" + codes[i];
	  	   	innerBlock[i].style.visibility = 'hidden';
	  			outerBlock[i].onclick = clickHandler;
			};
		};

		//Мешает массив codes
		function mixCodes() {
			codes.sort(compareRandom);

			function compareRandom(a, b) {
				return Math.random() - 0.5;
			};
		};

		//Прячет последние два цвета
		function hideTwoLastColors() {
			isTimeOut = false;
			currentColor.style.visibility = 'hidden';
			lastColor.style.visibility = 'hidden';
		};

		function clickHandler() {
			//Проверка успела ли сработать функция hideTwoLastColors
			if (isTimeOut) {
		   	clearTimeout(timerId);
		   	hideTwoLastColors();
			};

			clickCounter += 1;
			clickAmount.innerHTML = 'Количество открытий: ' + clickCounter;

			currentColor = this.querySelector('div');
			currentColor.style.visibility = '';


			if (clickCounter % 2 == 1) { //если открываем первый цвет
		   	lastColor = currentColor;
		   	this.onclick = "";

			} else { //если открываем второй цвет

		   	//если не совпал с первым цветом
		   	if (lastColor.className != currentColor.className) {
		   	  	isTimeOut = true;
		   	  	timerId = setTimeout(hideTwoLastColors, 600);
		   	  	lastColor.parentElement.onclick = clickHandler;
		   	} else { //если совпал с первым цветом
		     		lastColor.parentElement.onclick = "";
		     		this.onclick = "";
		    	 	lastColor = "";
		   	  	amountOfFoundPairs += 1

		  	   	//если открыли все пары цветов
		 	    	if (amountOfFoundPairs == 8) {
			     		winReport.style.visibility = "visible";
		     		};
		    	};
		  	};
		};

		let lastColor = "";
		let currentColor = "";
		let clickCounter = 0;
		let isTimeOut = false;
		let timerId = 0;
		let amountOfFoundPairs = 0;
		let codes = []; //Коды для дальнейшего присвания блокам
		let outerBlock;
		let innerBlock;
		let fieldSize;
		let restartGameButton = document.querySelector("#restartGameButton > button")

		restartGameButton.onclick = startGame;

		clickAmount.style.visibility = "hidden";
		gameField.style.visibility = "hidden";
		restartGameButton.style.visibility = "hidden";
	</script>
</body>
</html>
